#!/usr/bin/env ruby -KU

require 'open-uri'

def read(uri)
  open(uri) do |io|
    io.read
  end
end

def read_public(name)
  read(URI("http://pastie.org/#{name}.txt"))
end

def read_private(url)
  require 'rubygems'
  require 'hpricot'
  read(URI(Hpricot(open(url)).at('a.utility')['href']))
end

def main(arg)
  pattern = /^\d+$/
  return read_public(arg) if pattern =~ arg
  url = URI(arg)
  name = File.basename(url.path)
  return read_public(name) if pattern =~ name
  read_private(url)
end

def usage
  return <<-USAGE
Usage: #{File.basename $PROGRAM_NAME} PASTE_ID | PASTE_URL
USAGE
end

if __FILE__ == $PROGRAM_NAME
  unless ARGV.length == 1
    puts usage
    exit 2
  end
  puts main(ARGV.first)
end